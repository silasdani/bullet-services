<% content_for :title, I18n.t('dashboard.title') %>

<div class="dashboard-container">
  <!-- Header -->
  <div class="dashboard-header">
    <h1 class="dashboard-title">
      Dashboard
    </h1>
  </div>

  <!-- Key Metrics -->
  <div class="stats-grid">
    <div class="stat-card">
      <div class="stat-value"><%= @outstanding_count %></div>
      <div class="stat-label"><%= I18n.t('dashboard.outstanding_invoices') %></div>
    </div>
    <div class="stat-card">
      <div class="stat-value">£<%= sprintf("%.2f", (@outstanding_amount || 0).to_f).gsub(/(\d)(?=(\d{3})+(?!\d))/, '\1,') %></div>
      <div class="stat-label"><%= I18n.t('dashboard.outstanding_amount') %></div>
    </div>
    <div class="stat-card">
      <div class="stat-value"><%= @overdue_count || 0 %></div>
      <div class="stat-label"><%= I18n.t('dashboard.overdue') %></div>
    </div>
    <div class="stat-card">
      <div class="stat-value">£<%= sprintf("%.2f", (@overdue_amount || 0).to_f).gsub(/(\d)(?=(\d{3})+(?!\d))/, '\1,') %></div>
      <div class="stat-label"><%= I18n.t('dashboard.overdue_amount') %></div>
    </div>
  </div>

  <!-- Outstanding Invoices List -->
  <div class="invoices-section">
    <div class="section-header">
      <h2><%= I18n.t('dashboard.outstanding_invoices') %></h2>
      <a href="<%= rails_admin.index_path(model_name: 'invoice') %>" class="btn-link">
        <%= I18n.t('dashboard.view_all') %> →
      </a>
    </div>

    <% if @outstanding_invoices.blank? %>
      <div class="empty-state">
        <p><%= I18n.t('dashboard.no_outstanding') %></p>
      </div>
    <% else %>
      <table class="invoices-table">
        <thead>
          <tr>
            <th>Invoice</th>
            <th>Status</th>
            <th>Amount</th>
            <th>Due Date</th>
            <th></th>
          </tr>
        </thead>
        <tbody>
          <% @outstanding_invoices.each do |invoice| %>
            <% 
              status = invoice.final_status&.downcase || 'draft'
              freshbooks_invoice = invoice.freshbooks_invoices.first
              is_overdue = freshbooks_invoice&.due_date && freshbooks_invoice.due_date < Date.current
              status = 'overdue' if is_overdue && status != 'paid'
            %>
            <tr>
              <td>
                <a href="<%= rails_admin.show_path(model_name: 'invoice', id: invoice.id) %>">
                  <%= invoice.name || invoice.slug %>
                </a>
              </td>
              <td>
                <span class="status-badge <%= status %>"><%= status.upcase %></span>
              </td>
              <td>£<%= sprintf("%.2f", invoice.total_amount || 0) %></td>
              <td class="<%= 'overdue' if is_overdue %>">
                <%= freshbooks_invoice&.due_date ? freshbooks_invoice.due_date.strftime('%d %b %Y') : '-' %>
              </td>
              <td>
                <a href="<%= rails_admin.show_path(model_name: 'invoice', id: invoice.id) %>" class="btn-sm">View</a>
              </td>
            </tr>
          <% end %>
        </tbody>
      </table>
    <% end %>
  </div>
</div>
