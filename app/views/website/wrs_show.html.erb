<% content_for :title, "#{@wrs.reference_number} - Bullet Services" %>

<% content_for :head do %>
  <!-- WRS Show Page Styles -->
  <%= stylesheet_link_tag "website/wrs_show", "data-turbo-track": "reload" %>
<% end %>

<%= render NavigationComponent.new(current_path: request.path) %>

<main class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-12">
  <!-- Header Section -->
  <div class="mb-10 text-center">
    <h1 class="text-3xl font-bold tracking-tight text-[var(--color-primary-text)]">Window Schedule Repairs</h1>
    <p class="mt-2 text-[var(--color-secondary-text)]">Review the proposed works and confirm your decision below.</p>
  </div>

  <!-- Project Info Card -->
  <div class="bg-[var(--color-surface)] border border-[var(--color-border-divider)] mb-8 shadow-sm">
    <div class="grid grid-cols-1 md:grid-cols-3 divide-y md:divide-y-0 md:divide-x divide-[var(--color-border-divider)]">
      <div class="p-6 flex flex-col justify-center">
        <span class="text-[var(--color-secondary-text)] text-xs uppercase tracking-wider font-semibold mb-1">Project Reference</span>
        <span class="font-mono text-lg text-[var(--color-primary-text)] font-medium"><%= @wrs.reference_number %></span>
      </div>
      <div class="p-6 flex flex-col justify-center">
        <span class="text-[var(--color-secondary-text)] text-xs uppercase tracking-wider font-semibold mb-1">Site Address</span>
        <div class="flex flex-col">
          <span class="font-medium text-base text-[var(--color-primary-text)]"><%= @wrs.address %></span>
          <span class="text-sm text-[var(--color-secondary-text)]">Flat no. <%= @wrs.flat_number %></span>
        </div>
      </div>
      <div class="p-6 bg-gray-50/50 flex flex-col justify-center items-start md:items-end text-left md:text-right">
        <span class="text-[var(--color-secondary-text)] text-xs uppercase tracking-wider font-semibold mb-1">Total Estimated Cost</span>
        <div class="flex items-baseline gap-2">
          <span class="text-sm text-[var(--color-secondary-text)] font-medium">Incl. VAT</span>
          <span class="text-2xl font-bold text-[var(--color-primary-text)]">
            <%= number_to_currency(@wrs.total_vat_included_price || 0, unit: '£', precision: 2) %>
          </span>
        </div>
        <span class="text-xs text-[var(--color-secondary-text)] mt-1">
          <%= number_to_currency(@wrs.total_vat_excluded_price || 0, unit: '£', precision: 2) %> Excl. VAT
        </span>
      </div>
    </div>
  </div>

  <!-- Schedule of Works Section -->
  <div class="grid grid-cols-1 lg:grid-cols-12 gap-8 items-start relative">
    <div class="lg:col-span-12 space-y-8" id="schedule-section">
      <div class="bg-[var(--color-surface)] border border-[var(--color-border-divider)] overflow-visible shadow-sm z-0 relative">
        <div class="px-6 py-4 border-b border-[var(--color-border-divider)] bg-gray-50 flex justify-between items-center">
          <h2 class="font-bold text-sm uppercase tracking-wider text-[var(--color-primary-text)]">Schedule of Works</h2>
          <span class="text-xs font-mono text-[var(--color-secondary-text)]"><%= @wrs.windows.count %> ITEMS</span>
        </div>

        <!-- Desktop Header -->
        <div class="hidden md:grid grid-cols-12 gap-4 px-6 py-3 border-b border-[var(--color-border-divider)] bg-[var(--color-background)] text-xs font-semibold text-[var(--color-secondary-text)] uppercase tracking-wide">
          <div class="col-span-4">Location & Visual</div>
          <div class="col-span-6">Scope of Work</div>
          <div class="col-span-2 text-right">Cost (ex. VAT)</div>
        </div>

        <!-- Windows List -->
        <div class="divide-y divide-[var(--color-border-divider)]">
          <% @wrs.windows.order(:created_at).each_with_index do |window, index| %>
            <%
              window_price = window.total_price
              # Prices stored as integers - convert from pence to pounds if needed
              window_price = window_price / 100.0 if window_price && window_price > 1000
            %>
            <div class="group hover:bg-[var(--color-table-row-hover)] transition-colors duration-150 relative z-0 hover:z-30">
              <div class="grid grid-cols-1 md:grid-cols-12 gap-6 p-6 items-start">
                <!-- Location & Image -->
                <div class="md:col-span-4">
                  <div class="font-bold text-sm mb-3 text-[var(--color-primary-text)]"><%= window.location %></div>
                  <% if window.effective_image_url.present? %>
                    <div class="relative overflow-hidden border border-[var(--color-border-divider)] rounded cursor-zoom-in image-zoom-container">
                      <img
                        src="<%= window.effective_image_url %>"
                        alt="<%= window.location %>"
                        class="wrs-window-image w-full h-auto object-cover transition-transform duration-500 ease-out"
                        onerror="this.style.display='none'"
                        loading="lazy"
                      />
                    </div>
                  <% end %>
                </div>

                <!-- Scope & Price: mobile = aligned pairs, desktop = separate columns -->
                <div class="md:col-span-6 pt-1">
                  <span class="md:hidden text-xs font-bold text-[var(--color-secondary-text)] uppercase mb-1 block">Scope</span>
                  <% if window.tools.any? %>
                    <div class="space-y-2 text-sm text-[var(--color-primary-text)]">
                      <% window.tools.each do |tool| %>
                        <%
                          tool_price = tool.price
                          tool_price = tool_price / 100.0 if tool_price && tool_price > 1000
                        %>
                        <div class="flex justify-between items-center gap-4 md:block">
                          <div class="flex items-center gap-2">
                            <span class="w-1.5 h-1.5 rounded-full bg-gray-300 flex-shrink-0"></span>
                            <span><%= tool.name %></span>
                          </div>
                          <span class="font-medium font-mono text-[var(--color-primary-text)] md:hidden">£ <%= number_with_precision(tool_price || 0, precision: 0) %></span>
                        </div>
                      <% end %>
                    </div>
                  <% else %>
                    <div class="flex justify-between items-center gap-4 md:block">
                      <div class="text-sm text-[var(--color-secondary-text)] italic bg-gray-100/50 inline-block px-2 py-1 rounded">
                        No Works Required
                      </div>
                      <span class="font-mono text-[var(--color-secondary-text)] md:hidden">£ 0</span>
                    </div>
                  <% end %>
                </div>

                <!-- Price (desktop only) -->
                <div class="hidden md:block md:col-span-2 text-right pt-1">
                  <% if window.tools.any? %>
                    <div class="space-y-1 text-sm font-medium font-mono text-[var(--color-primary-text)]">
                      <% window.tools.each do |tool| %>
                        <%
                          tool_price = tool.price
                          tool_price = tool_price / 100.0 if tool_price && tool_price > 1000
                        %>
                        <div>£ <%= number_with_precision(tool_price || 0, precision: 0) %></div>
                      <% end %>
                    </div>
                  <% else %>
                    <div class="text-sm font-medium font-mono text-[var(--color-secondary-text)]">
                      £ 0
                    </div>
                  <% end %>
                </div>
              </div>
            </div>
          <% end %>
        </div>
      </div>

      <!-- Approval Section -->
      <div class="lg:col-span-12 mb-8" id="approval-section">
              <div class="bg-[var(--color-surface)] border border-[var(--color-border-divider)] shadow-sm">
                <div class="px-6 py-5 border-b border-[var(--color-border-divider)]">
                  <h2 class="text-lg font-bold text-[var(--color-primary-text)]">Approval of works</h2>
                  <p class="text-xs text-[var(--color-secondary-text)] mt-1">Important information about the proposed works</p>
                </div>
                <div class="px-6 py-6">
                  <h3 class="text-sm font-semibold text-[var(--color-primary-text)] mb-4">Please note:</h3>
                  <ul class="space-y-3 text-sm text-[var(--color-secondary-text)]">
                    <li>The proposed works have been acknowledged by the assigned contract administrator.</li>
                    <li>The condition survey has been carried out prior to any decorations.</li>
                    <li>The proposed works have been surveyed and priced in accordance with the signed contract.</li>
                    <li>Declining the works will result in the disregard of the proposed window works, mentioned above.</li>
                  </ul>
                </div>
              </div>
            </div>

            <!-- Description of Works Section - Native Accordion -->
            <div class="lg:col-span-12">
              <div class="bg-[var(--color-surface)] border border-[var(--color-border-divider)] h-full shadow-sm">
                <div class="px-6 py-5 border-b border-[var(--color-border-divider)]">
                  <h2 class="text-lg font-bold text-[var(--color-primary-text)]">Description of Works</h2>
                  <p class="text-xs text-[var(--color-secondary-text)] mt-1">Detailed breakdown of repair techniques</p>
                </div>
                <div class="divide-y divide-[var(--color-border-divider)]">
                  <!-- Accordion Item 1: Window Components Diagram -->
                  <details class="group">
                    <summary class="flex justify-between items-center cursor-pointer p-6 list-none text-[var(--color-primary-text)] hover:bg-gray-50 transition-colors">
                      <span class="text-sm font-medium">Window Components Diagram</span>
                      <span class="material-symbols-outlined text-[var(--color-secondary-text)] group-open:rotate-180 transition-transform duration-200">expand_more</span>
                    </summary>
                    <div class="text-sm text-[var(--color-secondary-text)] px-6 pb-6 pt-0 bg-gray-50/30">
                      <p class="mb-3">
                        These are the components of your typical <em>Sliding Sash Window</em>.
                      </p>
                      <p class="mb-3">
                        Even if your window is not a <em>Sliding Sash Window</em>, most components are common amongst the rest of them.
                      </p>
                      <p class="mb-4 text-sm">
                        Example: A cill is found both in <em>Sliding</em> and <em>Casement</em> type windows, as well as most wooden doors.
                      </p>
                      <%= image_tag "example.jpg", alt: "Window Components Diagram", class: "w-full max-w-2xl rounded-lg mb-3" %>
                    </div>
                  </details>

                  <!-- Accordion Item 2: Conservation Joint Repair -->
                  <details class="group">
                    <summary class="flex justify-between items-center cursor-pointer p-6 list-none text-[var(--color-primary-text)] hover:bg-gray-50 transition-colors">
                      <span class="text-sm font-medium">What is a Conservation Joint Repair</span>
                      <span class="material-symbols-outlined text-[var(--color-secondary-text)] group-open:rotate-180 transition-transform duration-200">expand_more</span>
                    </summary>
                    <div class="text-sm text-[var(--color-secondary-text)] px-6 pb-6 pt-0 bg-gray-50/30">
                      <p class="mb-3">
                        "Hairline Cracks" are the most predominant damages found in wooden windows. Wood expands and contracts due to the changes in temperature throughout the year. These small expansions/contractions produce cracks of the weatherproof barrier created by paint, leaving the bare wood exposed. Water can easily infiltrate the timber, which deteriorates it even further, rotting it away.
                      </p>
                      <p class="mb-3">
                        There are many factors that can contribute to these type of cracks, like excessive/aggressive movement, structural movement, inadequate window installation/decoration.
                      </p>
                      <p class="mb-2">The conservation joint repair comprises of the following steps:</p>
                      <ol class="list-decimal list-inside space-y-1">
                        <li>Opening up the crack and removing all of the existing rotten wood.</li>
                        <li>Priming the bare wood with a Water-based Acrylic Primer. (this reinforces the bare wood and prepares the surface for further repairs)</li>
                        <li>Filling in the crack with Epoxy Resin in accordance with the manufacturing instructions.</li>
                        <li>The surface is ready for painting.</li>
                      </ol>
                      <div class="mt-4 grid grid-cols-1 md:grid-cols-2 gap-4">
                        <%= image_tag "Conservation Joint Repair 1.jpeg", alt: "Conservation Joint Repair Example 1", class: "accordion-image mx-auto" %>
                        <%= image_tag "Conservation Joint Repair 2.jpeg", alt: "Conservation Joint Repair Example 2", class: "accordion-image mx-auto" %>
                      </div>
                    </div>
                  </details>

                  <!-- Accordion Item 3: Epoxy Resin Repair -->
                  <details class="group">
                    <summary class="flex justify-between items-center cursor-pointer p-6 list-none text-[var(--color-primary-text)] hover:bg-gray-50 transition-colors">
                      <span class="text-sm font-medium">What is an Epoxy Resin Repair</span>
                      <span class="material-symbols-outlined text-[var(--color-secondary-text)] group-open:rotate-180 transition-transform duration-200">expand_more</span>
                    </summary>
                    <div class="text-sm text-[var(--color-secondary-text)] px-6 pb-6 pt-0 bg-gray-50/30">
                      <p class="mb-3">
                        The Epoxy Resin Repair Kit has the purpose of filling medium to large areas of missing/decayed timber. Regular wood filler tends to crack in such instances.
                      </p>
                      <p>
                        In addition to its strength and flexibility, Epoxy Resin also provides a much better barrier against moisture and water.
                        The amount of required Epoxy tubes, depends on both the size of the affected area and the complexity of the pre-existing shape of the timber (multiple coats are needed for the restoration of intricate details - ex. the horns at the bottom end of sashes).
                      </p>
                      <div class="mt-4 grid grid-cols-1 md:grid-cols-2 gap-4">
                        <%= image_tag "Epoxy Resin Repair 1.jpeg", alt: "Epoxy Resin Repair Example 1", class: "accordion-image mx-auto" %>
                        <%= image_tag "Epoxy Resin Repair 2.jpeg", alt: "Epoxy Resin Repair Example 2", class: "accordion-image mx-auto" %>
                      </div>
                    </div>
                  </details>

                  <!-- Accordion Item 4: Timber Splicing Repair -->
                  <details class="group">
                    <summary class="flex justify-between items-center cursor-pointer p-6 list-none text-[var(--color-primary-text)] hover:bg-gray-50 transition-colors">
                      <span class="text-sm font-medium">What is a Timber Splicing Repair</span>
                      <span class="material-symbols-outlined text-[var(--color-secondary-text)] group-open:rotate-180 transition-transform duration-200">expand_more</span>
                    </summary>
                    <div class="text-sm text-[var(--color-secondary-text)] px-6 pb-6 pt-0 bg-gray-50/30">
                      <p>
                        In case the existing timber is damaged/rotten to the point where no restauration is possible, the section of wood is removed and replaced with a new Hardwood splice. This can be done on any component of the window.
                      </p>
                      <div class="mt-4 grid grid-cols-1 md:grid-cols-2 gap-4">
                        <%= image_tag "Timber Splicing Repair 1.jpeg", alt: "Timber Splicing Repair Example 1", class: "accordion-image mx-auto" %>
                        <%= image_tag "Timber Splicing Repair 2.jpeg", alt: "Timber Splicing Repair Example 2", class: "accordion-image mx-auto" %>
                      </div>
                    </div>
                  </details>

                  <!-- Accordion Item 5: Timber Cill Replacement -->
                  <details class="group">
                    <summary class="flex justify-between items-center cursor-pointer p-6 list-none text-[var(--color-primary-text)] hover:bg-gray-50 transition-colors">
                      <span class="text-sm font-medium">What is a Timber Cill Replacement</span>
                      <span class="material-symbols-outlined text-[var(--color-secondary-text)] group-open:rotate-180 transition-transform duration-200">expand_more</span>
                    </summary>
                    <div class="text-sm text-[var(--color-secondary-text)] px-6 pb-6 pt-0 bg-gray-50/30">
                      <p>
                        Similar to the Timber Splice Repair, if the pre-existing Timber Cill is damaged/rotten beyond repairs, the whole cill is removed and replaced with a new Hardwood Cill.
                      </p>
                      <div class="mt-4 grid grid-cols-1 md:grid-cols-2 gap-4">
                        <%= image_tag "Timber Cill Replacement 1.jpeg", alt: "Timber Cill Replacement Example 1", class: "accordion-image mx-auto" %>
                        <%= image_tag "Timber Cill Replacement 2.jpeg", alt: "Timber Cill Replacement Example 2", class: "accordion-image mx-auto" %>
                      </div>
                    </div>
                  </details>

                  <!-- Accordion Item 6: Front Face Repair -->
                  <details class="group">
                    <summary class="flex justify-between items-center cursor-pointer p-6 list-none text-[var(--color-primary-text)] hover:bg-gray-50 transition-colors">
                      <span class="text-sm font-medium">What is a Front Face Repair to the Timber Cill</span>
                      <span class="material-symbols-outlined text-[var(--color-secondary-text)] group-open:rotate-180 transition-transform duration-200">expand_more</span>
                    </summary>
                    <div class="text-sm text-[var(--color-secondary-text)] px-6 pb-6 pt-0 bg-gray-50/30">
                      <p>
                        In cases where the face section of the timber cill is damaged/rotten, but the rest of the cill is unaffected; the defective area is cut and replaced with new Hardwood Timber. Once again, this can only be done when the rest of the cill is still "healthy" and can suffice as a strong enough anchor for the screws that fix the new Hardwood face.
                      </p>
                      <div class="mt-4 grid grid-cols-1 md:grid-cols-2 gap-4">
                        <%= image_tag "Front Face Repair 1.jpeg", alt: "Front Face Repair Example 1", class: "accordion-image mx-auto" %>
                        <%= image_tag "Front Face Repair 2.jpeg", alt: "Front Face Repair Example 2", class: "accordion-image mx-auto" %>
                      </div>
                    </div>
                  </details>

                  <!-- Accordion Item 7: Rail Replacement -->
                  <details class="group">
                    <summary class="flex justify-between items-center cursor-pointer p-6 list-none text-[var(--color-primary-text)] hover:bg-gray-50 transition-colors">
                      <span class="text-sm font-medium">What is a Top/Meeting/Bottom Rail Replacement</span>
                      <span class="material-symbols-outlined text-[var(--color-secondary-text)] group-open:rotate-180 transition-transform duration-200">expand_more</span>
                    </summary>
                    <div class="text-sm text-[var(--color-secondary-text)] px-6 pb-6 pt-0 bg-gray-50/30">
                      <p>
                        A fully damaged/rotten rail will be replaced with a new Hardwood rail. The beading details or the putty (components that hold and seal the glazing panes) will be matched and replaced both on the exterior and the interior. Any ironmongery like sash lifts or fasteners will be preserved and reinstalled onto the new rail. The new rail will be painted both from the inside and the outside.
                      </p>
                      <div class="mt-4">
                        <%= image_tag "Top Meeting Bottom Rail Replacement.jpeg", alt: "Top/Meeting/Bottom Rail Replacement Example", class: "accordion-image mx-auto" %>
                      </div>
                    </div>
                  </details>

                  <!-- Accordion Item 8: Sash Cord Replacement -->
                  <details class="group">
                    <summary class="flex justify-between items-center cursor-pointer p-6 list-none text-[var(--color-primary-text)] hover:bg-gray-50 transition-colors">
                      <span class="text-sm font-medium">What is a Sash Cord Replacement</span>
                      <span class="material-symbols-outlined text-[var(--color-secondary-text)] group-open:rotate-180 transition-transform duration-200">expand_more</span>
                    </summary>
                    <div class="text-sm text-[var(--color-secondary-text)] px-6 pb-6 pt-0 bg-gray-50/30">
                      <p class="mb-3">
                        A Sliding Sash Window is designed to be lifted with ease through the help of the sash weight system found inside the casing of the window. Weights from inside the casing are tied with a Sash Cord, and using a pulley system, the window is both lifted and "held" in an open position. These cords are typically made from waxed cotton or nylon, and with time they can deteriorate to the point where they snap, rendering the window incapable of sliding and being " held" in an open position.
                      </p>
                      <p>
                        In this case, the only option is to replace the cord with a new cord. This can be done in some cases without the need of opening up the jamb.
                      </p>
                    </div>
                  </details>

                  <!-- Accordion Item 9: Ease and Adjust -->
                  <details class="group">
                    <summary class="flex justify-between items-center cursor-pointer p-6 list-none text-[var(--color-primary-text)] hover:bg-gray-50 transition-colors">
                      <span class="text-sm font-medium">What it means to Ease and Adjust the Sash Window</span>
                      <span class="material-symbols-outlined text-[var(--color-secondary-text)] group-open:rotate-180 transition-transform duration-200">expand_more</span>
                    </summary>
                    <div class="text-sm text-[var(--color-secondary-text)] px-6 pb-6 pt-0 bg-gray-50/30">
                      <p class="mb-3">
                        The sash weight system (see 'What is a Sash Cord Replacement'), contains metals (typically lead) that weighs the same as the window it's trying to pull. If the weight of the window changes, like it would when you replace the single glazed glass panes with double glazed glass panes; an imbalance in the system will occur, and thus the window will not be able to shut fully.
                      </p>
                      <p>
                        To fix this, we remove the jamb in order to reach the sash weights, and adjust the weights to their adequate amount.
                      </p>
                      <div class="mt-4">
                        <%= image_tag "Sash Cord.png", alt: "Sash Cord System", class: "accordion-image mx-auto" %>
                      </div>
                    </div>
                  </details>

                  <!-- Accordion Item 10: Putty Replacement -->
                  <details class="group">
                    <summary class="flex justify-between items-center cursor-pointer p-6 list-none text-[var(--color-primary-text)] hover:bg-gray-50 transition-colors">
                      <span class="text-sm font-medium">What is a Putty Replacement</span>
                      <span class="material-symbols-outlined text-[var(--color-secondary-text)] group-open:rotate-180 transition-transform duration-200">expand_more</span>
                    </summary>
                    <div class="text-sm text-[var(--color-secondary-text)] px-6 pb-6 pt-0 bg-gray-50/30">
                      <p class="mb-3">
                        Glazing Putty is the sealant holding the glass panes. It's typically made out of linseed oil, which handles moisture and water really well, however, excessive window movement or timber expansion can create cracks. Furthermore, this exposes the parting bead or the rail that the glass pane is sitting on, which overtime will rot.
                      </p>
                      <p>
                        It's recommended to replace your glazing putty every 10-20 years.
                      </p>
                    </div>
                  </details>
                </div>
              </div>
            </div>
          </div>

        </main>

        <!-- Floating Decision Form (appears between schedule and approval sections) -->
        <% unless @wrs.decision? %>
          <div id="floating-decision-form">
            <div class="bg-[var(--color-surface)] border-t border-[var(--color-border-divider)] shadow-[0_-8px_30px_rgba(0,0,0,0.12)]">
              <details class="group wrs-decision-collapsible" open>
                <summary class="flex justify-between items-center cursor-pointer px-4 sm:px-6 lg:px-8 py-4 list-none hover:bg-gray-50/50 transition-colors select-none">
                  <h3 class="font-semibold text-[var(--color-primary-text)]">Confirm your decision</h3>
                  <span class="material-symbols-outlined text-[var(--color-secondary-text)] group-open:rotate-180 transition-transform duration-200">expand_more</span>
                </summary>
              <div class="max-w-4xl mx-auto px-4 sm:px-6 lg:px-8 py-6 border-t border-[var(--color-border-divider)]">
                <% if flash[:alert].present? %>
                  <div class="mb-4 rounded-md bg-red-50 p-4 text-sm text-red-800 border border-red-200">
                    <%= flash[:alert] %>
                  </div>
                <% end %>

                <% if flash[:notice].present? %>
                  <div class="mb-4 rounded-md bg-green-50 p-4 text-sm text-green-800 border border-green-200">
                    <%= flash[:notice] %>
                  </div>
                <% end %>

                <%= form_with model: @decision_form,
                      url: wrs_decision_path(slug: @wrs.slug),
                      method: :post,
                      local: true,
                      html: { id: "wrs-decision-form", class: "space-y-5" } do |f| %>

                  <% if defined?(@decision_form) && @decision_form.errors.any? %>
                    <div class="mb-4 rounded-md bg-red-50 p-4 border border-red-200">
                      <h3 class="text-sm font-semibold text-red-800 mb-2">Please fix the following:</h3>
                      <ul class="list-disc list-inside text-sm text-red-800 space-y-1">
                        <% @decision_form.errors.full_messages.each do |msg| %>
                          <li><%= msg %></li>
                        <% end %>
                      </ul>
                    </div>
                  <% end %>

                  <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                    <div class="form-field-group">
                      <%= f.label :first_name, "First name", class: "label" %>
                      <%= f.text_field :first_name,
                               class: "w-full px-4 py-2.5 rounded-md bg-white text-[var(--color-primary-text)] placeholder:text-[var(--color-secondary-text)]",
                               placeholder: "John" %>
                    </div>
                    <div class="form-field-group">
                      <%= f.label :last_name, "Last name", class: "label" %>
                      <%= f.text_field :last_name,
                               class: "w-full px-4 py-2.5 rounded-md bg-white text-[var(--color-primary-text)] placeholder:text-[var(--color-secondary-text)]",
                               placeholder: "Doe" %>
                    </div>
                    <div class="form-field-group">
                      <%= f.label :email, "Email", class: "label" %>
                      <%= f.email_field :email,
                                class: "w-full px-4 py-2.5 rounded-md bg-white text-[var(--color-primary-text)] placeholder:text-[var(--color-secondary-text)]",
                                placeholder: "john@example.com" %>
                    </div>
                  </div>

                  <div class="flex items-center gap-3 pt-2">
                    <label class="inline-flex items-start gap-2.5 text-sm text-[var(--color-primary-text)] cursor-pointer">
                      <%= f.check_box :accept_terms, class: "mt-0.5 w-4 h-4 text-[var(--color-accent-action)] border-[var(--color-border-divider)] rounded focus:ring-[var(--color-accent-action)] cursor-pointer" %>
                      <span>
                        I have read and accept the
                        <%= link_to "Terms and Conditions", wrs_terms_path, target: "_blank", rel: "noopener", class: "font-semibold text-[var(--color-accent-action)] underline hover:no-underline" %>
                      </span>
                    </label>
                  </div>

                  <div class="flex gap-3 pt-2">
                    <%= f.hidden_field :decision, id: "decision-field" %>
                    <button
              type="button"
              data-decision="accept"
              class="decision-button flex-1 bg-[var(--color-accent-action)] text-white px-6 py-3.5 rounded-md shadow-lg hover:bg-gray-800 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-[var(--color-accent-action)]">
                      Accept
                    </button>
                    <button
              type="button"
              data-decision="decline"
              class="decision-button flex-1 bg-white border-2 border-[var(--color-border-divider)] text-[var(--color-primary-text)] px-6 py-3.5 rounded-md hover:bg-red-50 hover:text-red-600 hover:border-red-200 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-red-200">
                      Decline
                    </button>
                  </div>
                <% end %>
              </div>
              </details>
            </div>
          </div>
        <% end %>

        <script>
          document.addEventListener('DOMContentLoaded', () => {
            const scheduleSection = document.getElementById('schedule-section');
            const approvalSection = document.getElementById('approval-section');
            const floatingForm = document.getElementById('floating-decision-form');
            const decisionField = document.getElementById('decision-field');
            const form = document.getElementById('wrs-decision-form');

            if (!floatingForm) {
              console.error('Floating form not found');
              return;
            }

            // Handle image zoom on click
            document.querySelectorAll('.image-zoom-container').forEach(container => {
              const img = container.querySelector('.wrs-window-image');
              if (!img) return;

              container.addEventListener('click', (e) => {
                e.preventDefault();
                e.stopPropagation();

                if (container.classList.contains('zoomed')) {
                  // Close zoom
                  container.classList.remove('zoomed');
                  document.body.style.overflow = '';
                } else {
                  // Open zoom
                  container.classList.add('zoomed');
                  document.body.style.overflow = 'hidden';
                }
              });

              // Close on escape key
              const escapeHandler = (e) => {
                if (e.key === 'Escape' && container.classList.contains('zoomed')) {
                  container.classList.remove('zoomed');
                  document.body.style.overflow = '';
                }
              };
              document.addEventListener('keydown', escapeHandler);

              // Close on background click
              container.addEventListener('click', (e) => {
                if (container.classList.contains('zoomed') && e.target === container) {
                  container.classList.remove('zoomed');
                  document.body.style.overflow = '';
                }
              });
            });

            // Handle Accept/Decline button clicks
            document.querySelectorAll('[data-decision]').forEach(button => {
              button.addEventListener('click', (e) => {
                e.preventDefault();
                const decision = button.getAttribute('data-decision');
                if (decisionField) {
                  decisionField.value = decision;
                }
                if (form) {
                  form.submit();
                }
              });
            });

            // Show/hide floating form based on scroll position
            if (scheduleSection) {
              const updateFormVisibility = () => {
                const scheduleRect = scheduleSection.getBoundingClientRect();
                const viewportHeight = window.innerHeight;

                // Show form when we're near the end of the table (bottom is approaching or just past viewport)
                // Hide when we scroll back up to the top/middle of the table
                const scheduleBottom = scheduleRect.bottom;
                const scheduleTop = scheduleRect.top;

                // Show when: schedule bottom is near or past the viewport bottom (within 200px threshold)
                // This means we're at the end of the table or just past it
                const threshold = 200; // pixels from viewport bottom
                const isNearEnd = scheduleBottom <= viewportHeight + threshold;

                // Hide when: we're at the top/middle of the table (top is well above viewport)
                const isAtTop = scheduleTop > threshold;

                // Show if we're near the end AND not at the top
                if (isNearEnd && !isAtTop) {
                  floatingForm.classList.add('is-visible');
                } else {
                  floatingForm.classList.remove('is-visible');
                }
              };

              // Use IntersectionObserver for better performance
              const observer = new IntersectionObserver((entries) => {
                updateFormVisibility();
              }, {
                threshold: [0, 1],
                rootMargin: "0px"
              });

              observer.observe(scheduleSection);

              // Scroll event listener for real-time updates
              let ticking = false;
              const handleScroll = () => {
                if (!ticking) {
                  window.requestAnimationFrame(() => {
                    updateFormVisibility();
                    ticking = false;
                  });
                  ticking = true;
                }
              };

              window.addEventListener('scroll', handleScroll, { passive: true });
              window.addEventListener('resize', updateFormVisibility, { passive: true });

              // Initial check
              updateFormVisibility();
            } else {
              console.warn('Schedule section not found, form visibility not managed');
            }
          });
        </script>

        <%= render FooterComponent.new %>
