<% content_for :title, "WRS #{@wrs.reference_number} - Bullet Services" %>
<%= render NavigationComponent.new(current_path: request.path) %>
<div class="min-h-screen bg-white pt-24">
  <div class="container mx-auto px-6 py-12 max-w-6xl">
    <!-- Header Section - Centered -->
    <div class="text-center mb-12">
      <h1 class="text-4xl md:text-5xl font-light mb-6 text-gray-900">Windows Schedule Repairs</h1>
      <!-- Reference no. and Address - Inline, centered -->
      <div class="flex flex-wrap items-center justify-center gap-4 mb-6 text-sm md:text-base">
        <div class="flex items-center gap-2">
          <span class="font-semibold text-gray-700">reference no.</span>
          <span class="text-gray-900"><%= @wrs.reference_number %></span>
        </div>
        <div class="hidden md:block w-px h-4 bg-gray-300"></div>
        <div class="flex items-center gap-2">
          <span class="font-semibold text-gray-700">address</span>
          <span class="text-gray-900"><%= @wrs.address %></span>
        </div>
      </div>
      <!-- Flat no. - Inline label and value, centered -->
      <div class="flex items-center justify-center gap-3">
        <h2 class="text-sm font-semibold text-gray-700">Flat no.</h2>
        <h3 class="text-2xl font-semibold text-gray-900"><%= @wrs.flat_number %></h3>
      </div>
    </div>
    <!-- Windows Table -->
    <div class="mb-12 overflow-x-auto">
      <table class="w-full border-collapse">
        <thead>
          <tr class="border-b-2 border-gray-300">
            <th class="text-left py-4 px-4 font-semibold text-gray-900">Location</th>
            <th class="text-left py-4 px-4 font-semibold text-gray-900">Items</th>
            <th class="text-right py-4 px-4 font-semibold text-gray-900">Price (Excl. VAT)</th>
          </tr>
        </thead>
        <tbody>
          <% @wrs.windows.order(:created_at).each_with_index do |window, index| %>
            <tr class="border-b border-gray-200 hover:bg-gray-50 transition-colors">
              <!-- Window Name Column -->
              <td class="py-6 px-4 align-top">
                <div class="flex flex-col gap-3">
                  <% if window.effective_image_url.present? %>
                    <img
                      src="<%= window.effective_image_url %>"
                      alt="<%= window.location %>"
                      class="w-[400px] h-full object-cover rounded"
                      onerror="this.style.display='none'"
                    >
                    <% end %>
                    <span class="font-semibold text-gray-900"><%= window.location %></span>
                  </div>
                </td>
                <!-- Items Column -->
                <td class="py-6 px-4 align-top text-right">
                  <% if window.tools.any? %>
                    <ul class="space-y-2">
                      <% window.tools.each do |tool| %>
                        <li class="text-gray-800">
                          <%= tool.name %>
                        </li>
                      <% end %>
                    </ul>
                  <% else %>
                    <span class="text-gray-500 italic">No Works Required</span>
                  <% end %>
                </td>
                <!-- Price Column -->
                <td class="py-6 px-4 align-top text-right">
                  <%
                  window_price = window.total_price
                  # Prices stored as integers - convert from pence to pounds if needed
                  window_price = window_price / 100.0 if window_price && window_price > 1000
                %>
                  <span class="text-gray-900 font-medium">
                    <%= number_to_currency(window_price || 0, unit: '£', precision: 2) %>
                  </span>
                </td>
              </tr>
            <% end %>
          </tbody>
        </table>
      </div>
      <!-- Totals Section - Column direction, floating right -->
      <div class="mb-12 flex justify-end">
        <div class="p-8 bg-gray-50 rounded-lg">
          <div class="flex flex-col gap-6 items-end">
            <div>
              <h3 class="text-lg font-semibold text-gray-700 mb-2 text-right">Total exc. VAT</h3>
              <p class="text-3xl font-semibold text-gray-900">
                <%= number_to_currency(@wrs.total_vat_excluded_price || 0, unit: '£', precision: 2) %>
              </p>
            </div>
            <div>
              <h3 class="text-lg font-semibold text-gray-700 mb-2 text-right">Total incl. VAT</h3>
              <p class="text-4xl font-semibold text-gray-900">
                <%= number_to_currency(@wrs.total_vat_included_price || 0, unit: '£', precision: 2) %>
              </p>
            </div>
          </div>
        </div>
      </div>
      <!-- Approval Section -->
      <div class="mb-12 p-8 bg-gray-50 rounded-lg">
        <h2 class="text-2xl font-semibold text-gray-900 mb-6">Approval of works</h2>
        <div>
          <h3 class="text-lg font-semibold text-gray-700 mb-4">Please note:</h3>
          <ul class="space-y-3 text-gray-700">
            <li>The proposed works have been acknowledged by the assigned contract administrator.</li>
            <li>The condition survey has been carried out prior to any decorations.</li>
            <li>The proposed works have been surveyed and priced in accordance with the signed contract.</li>
            <li>Declining the works will result in the disregard of the proposed window works, mentioned above.</li>
          </ul>
        </div>
      </div>
      <!-- Description of Works Section - Accordion -->
      <div class="mb-12">
        <h2 class="text-2xl font-semibold text-gray-900 mb-6">Description of works</h2>
        <div class="space-y-2" data-accordion>
          <!-- Accordion Item 1: Window Components Diagram -->
          <div class="border border-gray-200 rounded-lg overflow-hidden">
            <button
            class="w-full text-left px-6 py-4 bg-white hover:bg-gray-50 transition-colors flex items-center justify-between focus:outline-none"
            data-accordion-toggle
            aria-expanded="false"
          >
              <span class="font-semibold text-gray-900">Window Components Diagram</span>
              <svg class="w-5 h-5 text-gray-500 transform transition-transform" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path>
              </svg>
            </button>
            <div class="hidden px-6 py-4 bg-gray-50 text-gray-700" data-accordion-content>
              <p class="mb-3">
                These are the components of your typical <em>Sliding Sash Window</em>.
              </p>
              <p class="mb-3">
                Even if your window is not a <em>Sliding Sash Window</em>, most components are common amongst the rest of them.
              </p>
              <p class="mb-4 text-sm">
                Example: A cill is found both in <em>Sliding</em> and <em>Casement</em> type windows, as well as most wooden doors.
              </p>
              <%= image_tag "example.jpg", alt: "Window Components Diagram", class: "w-full max-w-2xl rounded-lg mb-3" %>
            </div>
          </div>
          <!-- Accordion Item 2: Conservation Joint Repair -->
          <div class="border border-gray-200 rounded-lg overflow-hidden">
            <button
              class="w-full text-left px-6 py-4 bg-white hover:bg-gray-50 transition-colors flex items-center justify-between focus:outline-none"
              data-accordion-toggle
              aria-expanded="false"
            >
              <span class="font-semibold text-gray-900">What is a Conservation Joint Repair</span>
              <svg class="w-5 h-5 text-gray-500 transform transition-transform" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path>
              </svg>
            </button>
            <div class="hidden px-6 py-4 bg-gray-50 text-gray-700" data-accordion-content>
              <p class="mb-3">
                "Hairline Cracks" are the most predominant damages found in wooden windows. Wood expands and contracts due to the changes in temperature throughout the year. These small expansions/contractions produce cracks of the weatherproof barrier created by paint, leaving the bare wood exposed. Water can easily infiltrate the timber, which deteriorates it even further, rotting it away.
              </p>
              <p class="mb-3">
                There are many factors that can contribute to these type of cracks, like excessive/aggressive movement, structural movement, inadequate window installation/decoration.
              </p>
              <p class="mb-2">The conservation joint repair comprises of the following steps:</p>
              <ol class="list-decimal list-inside space-y-1">
                <li>Opening up the crack and removing all of the existing rotten wood.</li>
                <li>Priming the bare wood with a Water-based Acrylic Primer. (this reinforces the bare wood and prepares the surface for further repairs)</li>
                <li>Filling in the crack with Epoxy Resin in accordance with the manufacturing instructions.</li>
                <li>The surface is ready for painting.</li>
              </ol>
            </div>
          </div>
          <!-- Accordion Item 3: Epoxy Resin Repair -->
          <div class="border border-gray-200 rounded-lg overflow-hidden">
            <button 
            class="w-full text-left px-6 py-4 bg-white hover:bg-gray-50 transition-colors flex items-center justify-between focus:outline-none"
            data-accordion-toggle
            aria-expanded="false"
          >
              <span class="font-semibold text-gray-900">What is an Epoxy Resin Repair</span>
              <svg class="w-5 h-5 text-gray-500 transform transition-transform" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path>
              </svg>
            </button>
            <div class="hidden px-6 py-4 bg-gray-50 text-gray-700" data-accordion-content>
              <p class="mb-3">
                The Epoxy Resin Repair Kit has the purpose of filling medium to large areas of missing/decayed timber. Regular wood filler tends to crack in such instances.
              </p>
              <p>
                In addition to its strength and flexibility, Epoxy Resin also provides a much better barrier against moisture and water.
                The amount of required Epoxy tubes, depends on both the size of the affected area and the complexity of the pre-existing shape of the timber (multiple coats are needed for the restoration of intricate details - ex. the horns at the bottom end of sashes).
              </p>
            </div>
          </div>
          <!-- Accordion Item 4: Timber Splicing Repair -->
          <div class="border border-gray-200 rounded-lg overflow-hidden">
            <button 
            class="w-full text-left px-6 py-4 bg-white hover:bg-gray-50 transition-colors flex items-center justify-between focus:outline-none"
            data-accordion-toggle
            aria-expanded="false"
          >
              <span class="font-semibold text-gray-900">What is a Timber Splicing Repair</span>
              <svg class="w-5 h-5 text-gray-500 transform transition-transform" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path>
              </svg>
            </button>
            <div class="hidden px-6 py-4 bg-gray-50 text-gray-700" data-accordion-content>
              <p>
                In case the existing timber is damaged/rotten to the point where no restauration is possible, the section of wood is removed and replaced with a new Hardwood splice. This can be done on any component of the window.
              </p>
            </div>
          </div>
          <!-- Accordion Item 5: Timber Cill Replacement -->
          <div class="border border-gray-200 rounded-lg overflow-hidden">
            <button 
            class="w-full text-left px-6 py-4 bg-white hover:bg-gray-50 transition-colors flex items-center justify-between focus:outline-none"
            data-accordion-toggle
            aria-expanded="false"
          >
              <span class="font-semibold text-gray-900">What is a Timber Cill Replacement</span>
              <svg class="w-5 h-5 text-gray-500 transform transition-transform" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path>
              </svg>
            </button>
            <div class="hidden px-6 py-4 bg-gray-50 text-gray-700" data-accordion-content>
              <p>
                Similar to the Timber Splice Repair, if the pre-existing Timber Cill is damaged/rotten beyond repairs, the whole cill is removed and replaced with a new Hardwood Cill.
              </p>
            </div>
          </div>
          <!-- Accordion Item 6: Front Face Repair -->
          <div class="border border-gray-200 rounded-lg overflow-hidden">
            <button 
            class="w-full text-left px-6 py-4 bg-white hover:bg-gray-50 transition-colors flex items-center justify-between focus:outline-none"
            data-accordion-toggle
            aria-expanded="false"
          >
              <span class="font-semibold text-gray-900">What is a Front Face Repair to the Timber Cill</span>
              <svg class="w-5 h-5 text-gray-500 transform transition-transform" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path>
              </svg>
            </button>
            <div class="hidden px-6 py-4 bg-gray-50 text-gray-700" data-accordion-content>
              <p>
                In cases where the face section of the timber cill is damaged/rotten, but the rest of the cill is unaffected; the defective area is cut and replaced with new Hardwood Timber. Once again, this can only be done when the rest of the cill is still "healthy" and can suffice as a strong enough anchor for the screws that fix the new Hardwood face.
              </p>
            </div>
          </div>
          <!-- Accordion Item 7: Rail Replacement -->
          <div class="border border-gray-200 rounded-lg overflow-hidden">
            <button 
            class="w-full text-left px-6 py-4 bg-white hover:bg-gray-50 transition-colors flex items-center justify-between focus:outline-none"
            data-accordion-toggle
            aria-expanded="false"
          >
              <span class="font-semibold text-gray-900">What is a Top/Meeting/Bottom Rail Replacement</span>
              <svg class="w-5 h-5 text-gray-500 transform transition-transform" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path>
              </svg>
            </button>
            <div class="hidden px-6 py-4 bg-gray-50 text-gray-700" data-accordion-content>
              <p>
                A fully damaged/rotten rail will be replaced with a new Hardwood rail. The beading details or the putty (components that hold and seal the glazing panes) will be matched and replaced both on the exterior and the interior. Any ironmongery like sash lifts or fasteners will be preserved and reinstalled onto the new rail. The new rail will be painted both from the inside and the outside.
              </p>
            </div>
          </div>
          <!-- Accordion Item 8: Sash Cord Replacement -->
          <div class="border border-gray-200 rounded-lg overflow-hidden">
            <button 
            class="w-full text-left px-6 py-4 bg-white hover:bg-gray-50 transition-colors flex items-center justify-between focus:outline-none"
            data-accordion-toggle
            aria-expanded="false"
          >
              <span class="font-semibold text-gray-900">What is a Sash Cord Replacement</span>
              <svg class="w-5 h-5 text-gray-500 transform transition-transform" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path>
              </svg>
            </button>
            <div class="hidden px-6 py-4 bg-gray-50 text-gray-700" data-accordion-content>
              <p class="mb-3">
                A Sliding Sash Window is designed to be lifted with ease through the help of the sash weight system found inside the casing of the window. Weights from inside the casing are tied with a Sash Cord, and using a pulley system, the window is both lifted and "held" in an open position. These cords are typically made from waxed cotton or nylon, and with time they can deteriorate to the point where they snap, rendering the window incapable of sliding and being " held" in an open position.
              </p>
              <p>
                In this case, the only option is to replace the cord with a new cord. This can be done in some cases without the need of opening up the jamb.
              </p>
            </div>
          </div>
          <!-- Accordion Item 9: Ease and Adjust -->
          <div class="border border-gray-200 rounded-lg overflow-hidden">
            <button 
            class="w-full text-left px-6 py-4 bg-white hover:bg-gray-50 transition-colors flex items-center justify-between focus:outline-none"
            data-accordion-toggle
            aria-expanded="false"
          >
              <span class="font-semibold text-gray-900">What it means to Ease and Adjust the Sash Window</span>
              <svg class="w-5 h-5 text-gray-500 transform transition-transform" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path>
              </svg>
            </button>
            <div class="hidden px-6 py-4 bg-gray-50 text-gray-700" data-accordion-content>
              <p class="mb-3">
                The sash weight system (see 'What is a Sash Cord Replacement'), contains metals (typically lead) that weighs the same as the window it's trying to pull. If the weight of the window changes, like it would when you replace the single glazed glass panes with double glazed glass panes; an imbalance in the system will occur, and thus the window will not be able to shut fully.
              </p>
              <p>
                To fix this, we remove the jamb in order to reach the sash weights, and adjust the weights to their adequate amount.
              </p>
            </div>
          </div>
          <!-- Accordion Item 10: Putty Replacement -->
          <div class="border border-gray-200 rounded-lg overflow-hidden">
            <button 
            class="w-full text-left px-6 py-4 bg-white hover:bg-gray-50 transition-colors flex items-center justify-between focus:outline-none"
            data-accordion-toggle
            aria-expanded="false"
          >
              <span class="font-semibold text-gray-900">What is a Putty Replacement</span>
              <svg class="w-5 h-5 text-gray-500 transform transition-transform" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path>
              </svg>
            </button>
            <div class="hidden px-6 py-4 bg-gray-50 text-gray-700" data-accordion-content>
              <p class="mb-3">
                Glazing Putty is the sealant holding the glass panes. It's typically made out of linseed oil, which handles moisture and water really well, however, excessive window movement or timber expansion can create cracks. Furthermore, this exposes the parting bead or the rail that the glass pane is sitting on, which overtime will rot.
              </p>
              <p>
                It's recommended to replace your glazing putty every 10-20 years.
              </p>
            </div>
          </div>
        </div>
      </div>
      <!-- Client Decision Form -->
      <div class="mb-16 p-8 bg-white border border-gray-200 rounded-lg shadow-sm">
        <h2 class="text-2xl font-semibold text-gray-900 mb-6">Client details & decision</h2>

        <% if flash[:alert].present? %>
          <div class="mb-4 rounded-md bg-red-50 p-4 text-sm text-red-800">
            <%= flash[:alert] %>
          </div>
        <% end %>

        <% if flash[:notice].present? %>
          <div class="mb-4 rounded-md bg-green-50 p-4 text-sm text-green-800">
            <%= flash[:notice] %>
          </div>
        <% end %>

        <% if defined?(@decision_form) && @decision_form.errors.any? %>
          <div class="mb-6 rounded-md bg-red-50 p-4">
            <h3 class="text-sm font-semibold text-red-800 mb-2">Please fix the following:</h3>
            <ul class="list-disc list-inside text-sm text-red-800 space-y-1">
              <% @decision_form.errors.full_messages.each do |msg| %>
                <li><%= msg %></li>
              <% end %>
            </ul>
          </div>
        <% end %>

        <%= form_with model: @decision_form,
                      url: wrs_decision_path(slug: @wrs.slug),
                      method: :post,
                      local: true,
                      html: { class: "space-y-6" } do |f| %>
          <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
            <div>
              <%= f.label :first_name, "First name", class: "block text-sm font-medium text-gray-700 mb-1" %>
              <%= f.text_field :first_name,
                               class: "mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-gray-900 focus:ring-gray-900" %>
            </div>
            <div>
              <%= f.label :last_name, "Last name", class: "block text-sm font-medium text-gray-700 mb-1" %>
              <%= f.text_field :last_name,
                               class: "mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-gray-900 focus:ring-gray-900" %>
            </div>
          </div>

          <div>
            <%= f.label :email, "Email", class: "block text-sm font-medium text-gray-700 mb-1" %>
            <%= f.email_field :email,
                              class: "mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-gray-900 focus:ring-gray-900" %>
          </div>

          <div>
            <span class="block text-sm font-medium text-gray-700 mb-2">Do you accept the proposed works?</span>
            <div class="space-y-2">
              <label class="inline-flex items-center gap-2 text-sm text-gray-800">
                <%= f.radio_button :decision, "accept", class: "text-gray-900 border-gray-300 focus:ring-gray-900" %>
                <span>Accept the offer</span>
              </label>
              <label class="inline-flex items-center gap-2 text-sm text-gray-800">
                <%= f.radio_button :decision, "decline", class: "text-gray-900 border-gray-300 focus:ring-gray-900" %>
                <span>Decline the offer</span>
              </label>
            </div>
          </div>

          <div>
            <label class="inline-flex items-start gap-3 text-sm text-gray-700">
              <%= f.check_box :accept_terms, class: "mt-1 text-gray-900 border-gray-300 rounded focus:ring-gray-900" %>
              <span>
                I have read and accept the
                <a href="https://www.bulletservices.co.uk/terms-and-conditions"
                   target="_blank"
                   rel="noopener"
                   class="font-semibold text-gray-900 underline">
                  Terms and Conditions
                </a>.
              </span>
            </label>
          </div>

          <div class="pt-4">
            <%= f.submit "Submit", class: "inline-flex items-center justify-center px-6 py-3 border border-transparent text-sm font-medium rounded-md shadow-sm text-white bg-gray-900 hover:bg-black focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-gray-900" %>
          </div>
        <% end %>
      </div>
    </div>
  </div>
  <%= render FooterComponent.new %>
